<?xml version="1.0" encoding="UTF-8"?>
<component xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="racepoint_component_profile.xsd" manufacturer="Powershades" model="udp-api-v3"
  device_class="Shade_controller" minimum_component_engine_version="0" rpm_xml_version="1.7">


  <notes>
    Add or overwrite existing profile normally but set the ip address on the wire to 127.0.0.1.
    Once uploaded, open a terminal connection to the host and after login, paste and run the following script. 
    bash &lt;(curl -Ls "https://https://github.com/developer-powershades/savant-powershades-profile/tree/main/rubi-script")

    This is only needed once per savant system host.

    To Address each shade
    1 - 4 each octet of the ip address of the rf gateway or poe shade
    5. Channel Number: (use 0 for poe shades) otherwise determined by powershades config software

    Use Individual Variable Shade type for single shades
    Use Variable Shade type for RF Shade Groups
  </notes>
  <component_properties>

  </component_properties>
  <control_interfaces preferred="ip">
    <ip port="25809" response_time_length_ms="10000" protocol="tcp">
      <send_postfix type="hex">0D0A</send_postfix>
      <receive_end_condition test_condition="data" type="hex">0A</receive_end_condition>
    </ip>
  </control_interfaces>
  <media_interfaces>
    <data name_on_component="Ethernet">
      <combined_media>
        <data_media type="ethernet"/>
        <control port="25809"/>
      </combined_media>
    </data>
    
    <internal name_on_component="Shade">
      <environmental_media/>
      <resource resource_type="ENV_SHADECONTROLLER_SOURCE"/>
    </internal>
  </media_interfaces>
  <state_variable_list>
    <state_variable name="sequence_number" owning_logical_component="Shade Controller" state_center_binding="sequence_number" state_center_type="integer" min_value="0" max_value="255" wrap_around_type="difference">0</state_variable>
  </state_variable_list>
  <logical_component logical_component_name="Shade Controller">
    <implementation>
      <internal name_on_component="Shade"/>
    </implementation>
    <status_messages><!-- POE Shades appear to update on channel 1 not channel 0 as indicated in the documentation -->      
      <status_message name="DeviceStatus">
        <constant type="character">device_status,current_percent,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="ShadeLevel" type="integer"/>
        </data>
        <constant type="character">current_tilt,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="tilt" type="string"/>
        </data>
        <constant type="character">current_memory,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="memory" type="string"/>
        </data>
        <constant type="character">battery_voltage,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="battery_voltage" type="string"/>
        </data>
        <constant type="character">current_time,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="time" type="string"/>
        </data>
        <constant type="character">current_cycles,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="cycles" type="string"/>
        </data>
        <constant type="character">current_stalls,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="stalls" type="string"/>
        </data>
        <constant type="character">current_temperature,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="temperature" type="string"/>
        </data>
        <constant type="character">raw_percent,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="raw_percent" type="string"/>
        </data>
        <constant type="character">raw_tilt,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="raw_tilt" type="string"/>
        </data>
        <constant type="character">channel,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="channel" type="string"/>
        </data>
        <constant type="character">address,</constant>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_1" type="string"/>
        </data>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_2" type="string"/>
        </data>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_3" type="string"/>
        </data>
        <data type="character" terminator_type="end_of_data">
          <update state="octet_4" type="string"/>
        </data>
        <append_data_to_state_names state="octet_1"/>
        <append_data_to_state_names state="octet_2"/>
        <append_data_to_state_names state="octet_3"/>
        <append_data_to_state_names state="octet_4"/>
        <append_data_to_state_names state="channel"/>
      </status_message>
      <!-- response for poe shades from setposition doesn't provide any useful feedback -->
<!--      <status_message name="SetShadePositon">
        <constant type="character">set_position,mask,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="mask" type="string"/>
        </data>
        <constant type="character">percent,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="ShadeLevel" type="string"/>
        </data>
        <constant type="character">tilt,0,channel_mask,0,channel,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="channel" type="string"/>
        </data>
        <constant type="character">address,</constant>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_1" type="string"/>
        </data>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_2" type="string"/>
        </data>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_3" type="string"/>
        </data>
        <data type="character" terminator_type="end_of_data">
          <update state="octet_4" type="string"/>
        </data>
        <append_data_to_state_names state="octet_1"/>
        <append_data_to_state_names state="octet_2"/>
        <append_data_to_state_names state="octet_3"/>
        <append_data_to_state_names state="octet_4"/>
        <append_data_to_state_names state="channel"/>
      </status_message>-->
      <status_message name="SetGroupPositon">
        <constant type="character">set_position,mask,1,percent,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="ShadeLevel" type="string"/>
        </data>
        <constant type="character">tilt,0,channel_mask,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="channel" type="string"/>
        </data>
        <constant type="character">channel,0,address,</constant>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_1" type="string"/>
        </data>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_2" type="string"/>
        </data>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_3" type="string"/>
        </data>
        <data type="character" terminator_type="end_of_data">
          <update state="octet_4" type="string"/>
        </data>
        <append_data_to_state_names state="octet_1"/>
        <append_data_to_state_names state="octet_2"/>
        <append_data_to_state_names state="octet_3"/>
        <append_data_to_state_names state="octet_4"/>
        <append_data_to_state_names state="channel"/>
      </status_message>
      <status_message name="SerialNumber"> <!-- POE shade order doesn't match documentation -->
        <constant type="character">get_serial_number,model,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="model" type="string"/>
        </data>
        <constant type="character">direction,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="direction" type="string"/>
        </data>
        <constant type="character">serial_low,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="serial_low" type="string"/>
        </data>
        <constant type="character">serial_hi,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="serial_hi" type="string"/>
        </data>
        <constant type="character">dhcp_enabled,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="dhcp_enabled" type="string"/>
        </data>
        <constant type="character">ip_address,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="ip_address" type="string"/>
        </data>
        <constant type="character">subnet,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="subnet" type="string"/>
        </data>
        <constant type="character">gateway,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="gateway" type="string"/>
        </data>
        <constant type="character">channel,</constant>
        <data type="character" terminator_type="character" terminator=",">
          <update state="channel" type="string"/>
        </data>
        <constant type="character">address,</constant>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_1" type="string"/>
        </data>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_2" type="string"/>
        </data>
        <data type="character" terminator_type="character" terminator=".">
          <update state="octet_3" type="string"/>
        </data>
        <data type="character" terminator_type="end_of_data">
          <update state="octet_4" type="string"/>
        </data>          
        <append_data_to_state_names state="octet_1"/>
        <append_data_to_state_names state="octet_2"/>
        <append_data_to_state_names state="octet_3"/>
        <append_data_to_state_names state="octet_4"/>
        <append_data_to_state_names state="channel"/>
      </status_message>
      <status_message name="not_implemented">
        <data type="character" terminator_type="end_of_data">
          <update state="Unhandled Message" type="string"/>
        </data>
      </status_message>
    </status_messages>
    <resource_component_actions resource_type="ENV_SHADECONTROLLER_SOURCE">
      <action name="ShadeSet"><!-- Individual Shade -->
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <action_argument name="Address6" note="not used"/>
        <action_argument name="ShadeLevel" note="Target Shade Level (00 - 100, 0 being all the way down)"/>
        <action_argument name="DelayTime" note="not used"/>
        <action_argument name="FadeTime" note="not used"/> <!--  assume range -->
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string >powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">1A</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="mask">0001</parameter>
              <parameter parameter_data_type="character">,v-</parameter>
              <parameter parameter_data_type="character" name="percent" action_argument="ShadeLevel"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="tilt">0000</parameter>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character_hex" name="channel mask">00000000</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="10"/>
          </command>
        </command_interface>
      </action>
      <action name="ShadeStop"><!-- Individual Shade -->
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <action_argument name="Address6" note="not used"/>
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">1A</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="mask">0001</parameter>
              <parameter parameter_data_type="character">,v-</parameter>
              <parameter parameter_data_type="character" name="percent">255</parameter>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="tilt">0000</parameter>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character_hex" name="channel mask">00000000</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="10"/>
          </command>
        </command_interface>
      </action>
      <action name="RFShadeSet"><!-- Shade Group -->
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="Group Bitmask 0 - (1073741823 for all channels)"/>
        <action_argument name="Address6" note="not used"/>
        <action_argument name="ShadeLevel" note="Target Shade Level (00 - 100, 0 being all the way down)"/>
        <action_argument name="DelayTime" note="not used"/>
        <action_argument name="FadeTime" note="not used"/> <!--  assume range -->
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character_hex" name="opcode">1A</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character_hex" name="channel">00</parameter>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character_hex" name="reserved">00</parameter>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character_hex" name="mask">0001</parameter>
              <parameter parameter_data_type="character">,v-</parameter>
              <parameter parameter_data_type="character" name="percent" action_argument="ShadeLevel"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character_hex" name="tilt">0000</parameter>
              <parameter parameter_data_type="character">,V-</parameter>
              <parameter parameter_data_type="character" name="channel mask" action_argument="Address5"/>
            </parameter_list>
            <delay ms_delay="10"/>
          </command>
        </command_interface>
      </action>
      <entity name="Individual Variable Shade" address_components="5">
        <slider_representation>
          <press_action name="ShadeSet"/>
          <valueSource name="ShadeLevel">
            <unique_identifier name="Address1" address_component="1"/>
            <unique_identifier name="Address2" address_component="2"/>
            <unique_identifier name="Address3" address_component="3"/>
            <unique_identifier name="Address4" address_component="4"/>
            <unique_identifier name="Address5" address_component="5"/>
          </valueSource>
        </slider_representation>                
        <group_representation>
          <push_button_representation >
            <release_action name="ShadeSet">
              <argument name="ShadeLevel" value="0"/>
            </release_action>
            <osd_press_action name="ShadeSet">
              <argument name="ShadeLevel" value="0"/>
            </osd_press_action>
          </push_button_representation>
          <push_button_representation >
            <release_action name="ShadeSet">
              <argument name="ShadeLevel" value="20"/>
            </release_action>
            <osd_press_action name="ShadeSet">
              <argument name="ShadeLevel" value="20"/>
            </osd_press_action>
          </push_button_representation>
          <push_button_representation >
            <release_action name="ShadeSet">
              <argument name="ShadeLevel" value="40"/>
            </release_action>
            <osd_press_action name="ShadeSet">
              <argument name="ShadeLevel" value="40"/>
            </osd_press_action>
          </push_button_representation>
          <push_button_representation >
            <release_action name="ShadeSet">
              <argument name="ShadeLevel" value="60"/>
            </release_action>
            <osd_press_action name="ShadeSet">
              <argument name="ShadeLevel" value="60"/>
            </osd_press_action>
          </push_button_representation>
          <push_button_representation >
            <release_action name="ShadeSet">
              <argument name="ShadeLevel" value="80"/>
            </release_action>
            <osd_press_action name="ShadeSet">
              <argument name="ShadeLevel" value="80"/>
            </osd_press_action>
          </push_button_representation>
          <push_button_representation >
            <release_action name="ShadeSet">
              <argument name="ShadeLevel" value="100"/>
            </release_action>
            <osd_press_action name="ShadeSet">
              <argument name="ShadeLevel" value="100"/>
            </osd_press_action>
          </push_button_representation>
        </group_representation>
        <toggle_button_representation>
          <release_action name="ShadeSet">
            <argument name="ShadeLevel" value="100"/>
          </release_action>
          <toggle_action name="ShadeSet">
            <argument name="ShadeLevel" value="0"/>
          </toggle_action>
          <osd_press_action name="ShadeSet">
            <argument name="ShadeLevel" value="100"/>
          </osd_press_action>
          <osd_hold_action name="ShadeSet">
            <argument name="ShadeLevel" value="0"/>
          </osd_hold_action>
        </toggle_button_representation>
        <query_status_with_action name="GetStatus" period_ms="40000" send_on_reconnect="true">
          <with_arg name="Address1" address_component="1"/>
          <with_arg name="Address2" address_component="2"/>
          <with_arg name="Address3" address_component="3"/>
          <with_arg name="Address4" address_component="4"/>
          <with_arg name="Address5" address_component="5"/>
        </query_status_with_action>
      </entity>
      <entity name="Variable Shade" address_components="5">
        <slider_representation>
          <press_action name="RFShadeSet"/>
          <valueSource name="ShadeLevel">
            <unique_identifier name="Address1" address_component="1"/>
            <unique_identifier name="Address2" address_component="2"/>
            <unique_identifier name="Address3" address_component="3"/>
            <unique_identifier name="Address4" address_component="4"/>
            <unique_identifier name="Address5" address_component="5"/>
          </valueSource>
        </slider_representation>
        <group_representation>
          <push_button_representation >
            <release_action name="GroupSet">
              <argument name="ShadeLevel" value="0"/>
            </release_action>
            <osd_press_action name="GroupSet">
              <argument name="ShadeLevel" value="0"/>
            </osd_press_action>
          </push_button_representation>
          <push_button_representation >
            <release_action name="GroupSet">
              <argument name="ShadeLevel" value="20"/>
            </release_action>
            <osd_press_action name="GroupSet">
              <argument name="ShadeLevel" value="20"/>
            </osd_press_action>
          </push_button_representation>
          <push_button_representation >
            <release_action name="GroupSet">
              <argument name="ShadeLevel" value="40"/>
            </release_action>
            <osd_press_action name="GroupSet">
              <argument name="ShadeLevel" value="40"/>
            </osd_press_action>
          </push_button_representation>
          <push_button_representation >
            <release_action name="GroupSet">
              <argument name="ShadeLevel" value="60"/>
            </release_action>
            <osd_press_action name="GroupSet">
              <argument name="ShadeLevel" value="60"/>
            </osd_press_action>
          </push_button_representation>
          <push_button_representation >
            <release_action name="GroupSet">
              <argument name="ShadeLevel" value="80"/>
            </release_action>
            <osd_press_action name="GroupSet">
              <argument name="ShadeLevel" value="80"/>
            </osd_press_action>
          </push_button_representation>
          <push_button_representation >
            <release_action name="GroupSet">
              <argument name="ShadeLevel" value="100"/>
            </release_action>
            <osd_press_action name="GroupSet">
              <argument name="ShadeLevel" value="100"/>
            </osd_press_action>
          </push_button_representation>
        </group_representation>
        <toggle_button_representation>
          <release_action name="GroupSet">
            <argument name="ShadeLevel" value="100"/>
          </release_action>
          <toggle_action name="GroupSet">
            <argument name="ShadeLevel" value="0"/>
          </toggle_action>
          <osd_press_action name="GroupSet">
            <argument name="ShadeLevel" value="100"/>
          </osd_press_action>
          <osd_hold_action name="GroupSet">
            <argument name="ShadeLevel" value="0"/>
          </osd_hold_action>
        </toggle_button_representation>
      </entity>
    </resource_component_actions>
    <custom_component_actions>
      <action name="GetSerialNumber">
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <action_argument name="Address6" note="not used"/>
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">00</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="100"/>
          </command>
        </command_interface>
      </action>
      <action name="JogUp">
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <action_argument name="Address6" note="not used"/>
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">03</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="100"/>
          </command>
        </command_interface>
      </action>
      <action name="JogDown">
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <action_argument name="Address6" note="not used"/>
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">04</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="100"/>
          </command>
        </command_interface>
      </action>
      <action name="JogStop">
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <action_argument name="Address6" note="not used"/>
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">05</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="100"/>
          </command>
        </command_interface>
      </action>
      <action name="PairDevice"> <!-- RF Only -->
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <action_argument name="Address6" note="not used"/>
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">06</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="100"/>
          </command>
        </command_interface>
      </action>
      <action name="UnPairDevice"> <!-- RF Only -->
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <action_argument name="Address6" note="not used"/>
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">07</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="100"/>
          </command>
        </command_interface>
      </action>
      <action name="Indicate-Beep"> <!-- POE Only -->
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <action_argument name="Address6" note="not used"/>
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">08</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="100"/>
          </command>
        </command_interface>
      </action>
      <action name="P2Button"> <!-- RF Only -->
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <action_argument name="Address6" note="not used"/>
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">16</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="100"/>
          </command>
        </command_interface>
      </action>
      <action name="LinkFeedback"> <!-- RF Only -->
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <action_argument name="Address6" note="not used"/>
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">21</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="100"/>
          </command>
        </command_interface>
      </action>
      <action name="GetStatus">
        <action_argument name="Address1" note="0 - 255"/>
        <action_argument name="Address2" note="0 - 255"/>
        <action_argument name="Address3" note="0 - 255"/>
        <action_argument name="Address4" note="0 - 255"/>
        <action_argument name="Address5" note="0 - 30 Device Channel"/>
        <update_state_variable name="sequence_number" update_type="increment" update_source="constant">1</update_state_variable>   
        <command_interface interface="ip">
          <command response_required="no">
            <command_string>powershades_udp.send_message('</command_string>
            <parameter_list>
              <parameter parameter_data_type="character" action_argument="Address1"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address2"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address3"/>
              <parameter parameter_data_type="character">.</parameter>
              <parameter parameter_data_type="character" action_argument="Address4"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="opcode">1D</parameter>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="sequence" state_variable="sequence_number"/>
              <parameter parameter_data_type="character">,C-</parameter>
              <parameter parameter_data_type="character" name="channel" action_argument="Address5"/>
              <parameter parameter_data_type="character">,</parameter>
              <parameter parameter_data_type="character" name="reserved">00</parameter>
              <parameter parameter_data_type="character">')</parameter>
            </parameter_list>
            <delay ms_delay="100"/>
          </command>
        </command_interface>
      </action>
      <action name="START">
        <command_interface interface="ip">
          <command response_required="no">
            <command_string type="character"/>
            <parameter_list>
              <parameter parameter_data_type="character"><![CDATA[

require 'socket'
include Socket::Constants
require 'logger'

$l = Logger.new($stderr)
$l.level = Logger::ERROR
# $l.level = Logger::DEBUG

def local_ip
  return '0.0.0.0' if RUBY_PLATFORM == 'arm-linux-gnueabi'
  Socket.ip_address_list.to_s[/ ((?!127)\d\d?\d?\.[0-9]+\.[0-9]+\.[0-9]+)/,1]
end

class Powershades < UDPSocket

  attr_accessor :port, :buffer
  
  def initialize
    super
    self.bind(local_ip, 0)
    @port = addr[1]
  end

  def read_lines
    buffer = {}
    loop do
      r = IO.select([self],nil,nil,1)
      break unless r && r[0]
      data, info = recvfrom_nonblock(1024)
      (buffer[info[3]] ||= '' ) << data
      buffer = handle_buffer(buffer)
    end
  end

  def handle_buffer(buffer)
    buffer.keys.each do |k|
      data = buffer[k]
      length,data  = parse(data)
      next unless length  
      $stdout.puts "#{data},address,#{k}" if data
      $l.debug "packet decoded, removing #{length} bytes from input buffer for #{k}"
      buffer[k][0..length - 1] = ''
      $l.debug buffer
    end
    buffer
  end
  
  def parse(data)
    return unless data.length > 7 # skip if incomplete data exists
  $l.debug data.inspect
    payload_length = data[0..1].unpack('v')[0]
  $l.debug ['payload length', payload_length]
    payload_crc = data[2..3].unpack('v')[0]
  $l.debug payload_crc
    crc_length = 4 + payload_length
    return unless data.length >= crc_length
    crc_data = data[4..(crc_length + 3)]
    calculated_crc = get_crc(crc_data).unpack('v')[0]
  $l.debug "CRC Error #{calculated_crc.inspect} vs payload #{payload_crc} for #{crc_data}" unless payload_crc == calculated_crc
    operation_code = data[4].unpack('C')[0]
  $l.debug "op code: #{operation_code}"
    sequence_code = data[5].unpack('C')[0]
  $l.debug "seq code: #{sequence_code}"
    channel_number = data[6].unpack('C')[0]
  $l.debug "channel number: #{channel_number}"
    packet_length = payload_length + 8
    if payload_length > 0
      payload_data = data[8..(packet_length - 1)]
      payload = (get_payload(operation_code, payload_data) || []).join(',')
      payload = "#{payload},channel,#{channel_number}"
    $l.debug payload
      return [packet_length, payload]
    end
    [packet_length]
  end
  
  def send_message(message)
    address, *data = message.split(',')
    data = data.map do |b|
      if b.match(/([CvV])-(\d+)/)
        [$2.to_i].pack($1)
      else
        [b].pack('H*').reverse
      end
    end
    data = data.join
    length = [data.length - 4].pack('v')
    crc = get_crc(data)
    res = ''
    res << length
    res << crc
    res << data
    send(res, 0, address, 42)
    [address, res.bytes]
  rescue => e
    $l.error [e,e.backtrace]
  end
  
  def get_crc(byte_string)
    crc = 0x0000
    byte_string.bytes do |b|
      8.times do |i|
        bit = ((b   >> (7 - i) & 1) == 1)
        c15 = ((crc >> 15 & 1) == 1)
        crc <<= 1
        crc ^= 0x1021 if c15 ^ bit
      end
    end
    [crc & 0xffff].pack('v')
  end
  
  def get_payload(opcode, data)
  $l.debug data.inspect
    case opcode
    when 0x00 # Get Serial Number
      [ # is protocol guide wrong or is sample data flawed
        :get_serial_number,
        :model, data[0].unpack('C')[0],
        :direction, data[3].unpack('C')[0],
        :serial_low, data[4..7].unpack('V')[0],
        :serial_hi, data[8..11].unpack('V')[0],
        :dhcp_enabled, data[12].unpack('C')[0],
        #:ip_address, data[13..16].bytes.join('.'),
        :ip_address, data[17..20].bytes.join('.'),
        #:subnet, data[17..20].bytes.join('.'),
        :subnet, data[21..24].bytes.join('.'),
        #:gateway, data[21..24].bytes.join('.')
        :gateway, data[25..28].bytes.join('.')
      ]
    when 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x16, 0x21
      []
    when 0x1a # Set Position
      $l.debug 'will a group move be followed up by unsolicited status update '\
        'or should we push this info to savant for each channel? '\
        'set position reply seems to ack only on poe shade '
      [
        :set_position,
        :mask, data[0..1].unpack('v')[0],
        :percent, data[2..3].unpack('v')[0],
        :tilt, data[4..5].unpack('v')[0],
        :channel_mask, (data[6..9] || '0').unpack('V')[0]
      ]
    when 0x1d # Get Status
      [
        :device_status,
        :current_percent, data[0..1].unpack('v')[0],
        :current_tilt, data[2..3].unpack('v')[0],
        :current_memory, data[4..5].unpack('v')[0], # future
        :battery_voltage, data[6..7].unpack('v')[0],
        :current_time, data[8..11].unpack('V')[0], # future
        :current_cycles, data[12..15].unpack('V')[0], # future
        :current_stalls, data[16..19].unpack('V')[0], # future
        :current_temperature, data[20..21].unpack('v')[0], # future
        :raw_percent, data[22..25].unpack('V')[0], # future
        :raw_tilt, data[26..29].unpack('v')[0] # future
      ]
    else
      raise "unknown opcode #{opcode} with data #{data}"
    end
  rescue => e
    $l.error [e,e.backtrace]
    []
  end
  
end

powershades_udp = Powershades.new
Thread.abort_on_exception = true
Thread.new{loop{powershades_udp.read_lines}}

                ]]></parameter>
            </parameter_list>
            <delay ms_delay="10000"/>
          </command>
        </command_interface>
        <execute_on_schedule period_ms="0"></execute_on_schedule>
      </action>
    </custom_component_actions>
  </logical_component>
</component>
